---
layout: single
title: "ğŸš€é¢ è¦†ä¼ ç»ŸAIæ™ºèƒ½ä½“ï¼AutoGené©å‘½æ€§åˆ›æ–°GraphFlowæŠ€æœ¯ï¼è®©AIå›¢é˜Ÿè‡ªåŠ¨åä½œï¼5åˆ†é’Ÿå®ç°å®ç°æ™ºèƒ½ä½“å·¥ä½œæµè‡ªåŠ¨åŒ–ï¼AutoGen GraphFlowä¿å§†çº§å®æˆ˜æ•™ç¨‹ï¼æ”¯æŒQwen3ä¸ollama"
sidebar:
  nav: "docs"
date: 2025-05-09 00:00:00 +0800
categories: AIAgents
tags: [AutoGen, GraphFlow, AIæ™ºèƒ½ä½“ , AI Agents, å·¥ä½œæµ, AIAgents, Gemini, Qwen3, æ™ºèƒ½ä½“]
classes: wide
author_profile: true
---

åœ¨AIæ™ºèƒ½ä½“é¢†åŸŸï¼Œå¾®è½¯çš„AutoGenå›¢é˜Ÿè¿‘æœŸæ¨å‡ºäº†ä¸€é¡¹å¼•äººæ³¨ç›®çš„æ–°ç‰¹æ€§--GraphFlowã€‚è¿™ä¸€åˆ›æ–°ç»„ä»¶ä¸ºAIå¤šä»£ç†ç³»ç»Ÿå¸¦æ¥äº†é«˜åº¦çµæ´»ä¸”å¹¶å‘å‹å¥½çš„å·¥ä½œæµç¼–æ’èƒ½åŠ›ï¼Œæå¤§æå‡äº†å›¢é˜Ÿåä½œçš„æ•ˆç‡å’Œå¯æ§æ€§ã€‚

**ä»€ä¹ˆæ˜¯GraphFlowï¼Ÿ**

GraphFlowæ˜¯AutoGen AgentChat APIä¸­çš„ä¸€æ¬¾å…¨æ–°å›¢é˜Ÿç±»ï¼Œå¯ä»¥å°†AIä»£ç†çš„åä½œæµç¨‹æŠ½è±¡ä¸ºæœ‰å‘å›¾ã€‚ä¸ä¼ ç»Ÿçš„çº¿æ€§æˆ–ç®€å•åˆ†ç»„èŠå¤©ä¸åŒï¼ŒGraphFlowå…è®¸å¼€å‘è€…ä»¥å›¾ç»“æ„ç²¾å‡†æ§åˆ¶æ¯ä¸ªä»£ç†çš„ä»»åŠ¡åˆ†å‘ã€å¹¶è¡Œå¤„ç†å’Œç»“æœæ±‡æ€»è¿‡ç¨‹ã€‚è¿™æ„å‘³ç€ï¼Œå¤æ‚çš„å›¢é˜Ÿåä½œåœºæ™¯ï¼Œå¦‚å¤šè½®ç¼–è¾‘ã€æ„è§èåˆã€å¹¶è¡Œå®¡æ ¸ç­‰ï¼Œéƒ½å¯ä»¥é€šè¿‡å›¾ç»“æ„çµæ´»å®ç°ã€‚

**æ ¸å¿ƒä¼˜åŠ¿ä¸åº”ç”¨åœºæ™¯**

- å¹¶å‘æ‰§è¡Œï¼šGraphFlowæ”¯æŒå¤šä¸ªä»£ç†åŒæ—¶å¤„ç†ä»»åŠ¡ï¼Œå¤§å¹…ç¼©çŸ­æ•´ä½“æµç¨‹æ—¶é—´ã€‚
- çµæ´»ç¼–æ’ï¼šé€šè¿‡è‡ªå®šä¹‰æœ‰å‘å›¾ï¼Œå¼€å‘è€…å¯ä»¥è‡ªç”±è®¾è®¡ä»»åŠ¡çš„åˆ†æ”¯ã€åˆå¹¶ä¸ä¾èµ–å…³ç³»ï¼Œæ»¡è¶³å„ç§å¤æ‚åä½œéœ€æ±‚ã€‚
- å¯è§†åŒ–ä¸å¯æ§æ€§ï¼šå›¾ç»“æ„è®©æ•´ä½“æµç¨‹ä¸€ç›®äº†ç„¶ï¼Œä¾¿äºè°ƒè¯•å’Œä¼˜åŒ–ã€‚

åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒGraphFlowéå¸¸é€‚åˆéœ€è¦å¤šè§’è‰²ååŒçš„åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œå†…å®¹ç”Ÿæˆæµç¨‹å¯ä»¥è®©â€œå†™æ‰‹â€ä»£ç†å…ˆèµ·è‰æ–‡æœ¬ï¼Œç„¶åå¹¶è¡Œåˆ†å‘ç»™â€œè¯­æ³•ç¼–è¾‘â€å’Œâ€œé£æ ¼ç¼–è¾‘â€ï¼Œæœ€åç”±â€œç»ˆå®¡â€ä»£ç†æ•´åˆæ‰€æœ‰ä¿®æ”¹ï¼Œè¾“å‡ºé«˜è´¨é‡æˆå“ã€‚è¿™ç§â€œæ‰‡å‡º-æ±‡åˆâ€æ¨¡å¼ä¸ä»…æå‡äº†æ•ˆç‡ï¼Œä¹Ÿä¿è¯äº†å†…å®¹çš„å¤šç»´åº¦ä¼˜åŒ–ã€‚

ä¸Šæ‰‹GraphFlowéå¸¸ç®€å•ã€‚å¼€å‘è€…åªéœ€å®šä¹‰å„ä¸ªä»£ç†èŠ‚ç‚¹åŠå…¶èŒè´£ï¼Œé€šè¿‡DiGraphBuilderæ„å»ºæµç¨‹å›¾ï¼Œå†ç”¨GraphFlowç±»è¿è¡Œä»»åŠ¡å³å¯ã€‚

### ğŸ”¥AutoGenå®‰è£…

```python
pip install -U "autogen-agentchat" "autogen-ext[openai]" "autogen-ext[ollama]" "autogen-ext[mcp]" 

export OPENAI_API_KEY=sk-proj-xxx

export GEMINI_API_KEY=sk-proj-xxx
```

### ğŸ”¥é¡ºåºå·¥ä½œæµ

```python
# å¯¼å…¥å¿…è¦çš„åº“
import asyncio
from autogen_agentchat.agents import AssistantAgent
from autogen_agentchat.teams import DiGraphBuilder, GraphFlow
from autogen_ext.models.openai import OpenAIChatCompletionClient
from autogen_ext.models.ollama import OllamaChatCompletionClient
from autogen_core.models import ModelFamily,ModelInfo

async def main():
    # åˆ›å»ºOpenAIæ¨¡å‹å®¢æˆ·ç«¯
    model_client = OpenAIChatCompletionClient(model="gpt-4.1-nano")

    # åˆ›å»ºGeminiæ¨¡å‹å®¢æˆ·ç«¯
    gemini_client = OpenAIChatCompletionClient(
    model="gemini-2.0-flash-lite",
    model_info=ModelInfo(vision=True, function_calling=True, json_output=True, family="unknown", structured_output=True)
    # api_key="GEMINI_API_KEY",
)
    # åˆ›å»ºollamaæ¨¡å‹å®¢æˆ·ç«¯
    ollama_client = OllamaChatCompletionClient(
        model="qwen3:14b",
        # model="phi4-mini:latest",
        # model="llama3.1",
        model_info = {
            "vision": False,
            "function_calling": True,
            "json_output": True,
            "family": ModelFamily.UNKNOWN, # ModelFamily éœ€è¦ä» autogen_core.models å¯¼å…¥
            "structured_output": True,
        },
    )

    # ğŸ”¥AIè¶…å…ƒåŸŸé¢‘é“åŸåˆ›è§†é¢‘
    # åˆ›å»ºä»£ç†
    # ç¿»è¯‘å™¨ä»£ç† - è´Ÿè´£å°†æ–‡æœ¬ä»è‹±æ–‡ç¿»è¯‘ä¸ºä¸­æ–‡
    translator = AssistantAgent(
        "translator",
        model_client=ollama_client,
        system_message="ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è‹±æ–‡åˆ°ä¸­æ–‡ç¿»è¯‘ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†ç”¨æˆ·æä¾›çš„è‹±æ–‡æ–‡æœ¬å‡†ç¡®ç¿»è¯‘æˆä¸­æ–‡ï¼Œä¿æŒåŸæ–‡çš„è¯­æ°”å’Œé£æ ¼ã€‚"
    )

    # æ ¡å¯¹è€…ä»£ç† - è´Ÿè´£æ£€æŸ¥ç¿»è¯‘è´¨é‡å¹¶è¿›è¡Œä¿®æ”¹
    proofreader = AssistantAgent(
        "proofreader",
        model_client=gemini_client,
        system_message="ä½ æ˜¯ä¸€ä½ä¸­æ–‡æ ¡å¯¹ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ£€æŸ¥ç¿»è¯‘æ–‡æœ¬çš„å‡†ç¡®æ€§å’Œæµç•…åº¦ï¼Œç¡®ä¿æ²¡æœ‰é”™è¯¯å¹¶æå‡ºä¿®æ”¹å»ºè®®ã€‚"
    )

    # æ ¼å¼åŒ–ä»£ç† - è´Ÿè´£æœ€ç»ˆè¾“å‡ºæ ¼å¼çš„è°ƒæ•´
    formatter = AssistantAgent(
        "formatter",
        model_client=model_client,
        system_message="ä½ æ˜¯ä¸€ä½æ–‡æ¡£æ ¼å¼ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç¿»è¯‘åçš„æ–‡æœ¬è¿›è¡Œæœ€ç»ˆæ ¼å¼è°ƒæ•´ï¼Œç¡®ä¿æ®µè½åˆ†æ˜ï¼Œæ ‡ç‚¹ç¬¦å·æ­£ç¡®ï¼Œå¹¶ä¿æŒä¸€è‡´çš„é£æ ¼ã€‚"
    )

    # æ„å»ºæ‰§è¡Œå›¾
    builder = DiGraphBuilder()

    # æ·»åŠ èŠ‚ç‚¹
    builder.add_node(translator).add_node(proofreader).add_node(formatter)

    # æ·»åŠ è¾¹ï¼ˆå®šä¹‰æ‰§è¡Œé¡ºåºï¼‰
    builder.add_edge(translator, proofreader)
    builder.add_edge(proofreader, formatter)

    # æ„å»ºå’ŒéªŒè¯å›¾
    graph = builder.build()

    # åˆ›å»ºGraphFlow
    flow = GraphFlow(
        participants=builder.get_participants(),
        graph=graph
    )

    # è¿è¡Œå·¥ä½œæµ
    result = await flow.run(
        task="Translate the following text to Chinese: 'Artificial intelligence is transforming the way we work and live. It offers new opportunities and challenges that we must navigate carefully.'")

    # æ‰“å°ç»“æœ
    for message in result.messages:
        print(f"{message.source}: {message.content}")

if __name__ == "__main__":
    asyncio.run(main())
```

### ğŸ”¥å¹¶è¡Œå·¥ä½œæµ

```python
"""
AutoGen v0.5.6 GraphFlow - Parallel Flow with Join ç¤ºä¾‹

è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨AutoGen v0.5.6çš„GraphFlowåŠŸèƒ½åˆ›å»ºå¹¶æ‰§è¡Œä¸€ä¸ªåŒ…å«å¹¶è¡Œå¤„ç†å’Œåˆå¹¶èŠ‚ç‚¹çš„å·¥ä½œæµã€‚
åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä»¥ä¸‹å·¥ä½œæµï¼š
1. ä¸€ä¸ªç¼–å†™äººå‘˜(writer)è´Ÿè´£èµ·è‰ä¸€ä¸ªçŸ­æ–‡æ®µ
2. ä¸¤ä¸ªç¼–è¾‘åŒæ—¶å·¥ä½œï¼šä¸€ä¸ªè´Ÿè´£è¯­æ³•(editor_grammar)ï¼Œä¸€ä¸ªè´Ÿè´£é£æ ¼(editor_style)
3. æœ€åä¸€ä¸ªç»ˆå®¡ç¼–è¾‘(final_reviewer)å°†ä¸¤ä¸ªç¼–è¾‘çš„ç»“æœè¿›è¡Œæ•´åˆ

GraphFlow æ˜¯AutoGen v0.5.6æ–°å¢çš„ä¸€ä¸ªå®éªŒæ€§åŠŸèƒ½ï¼Œå®ƒå…è®¸ä½ é€šè¿‡æœ‰å‘å›¾æ¥æ§åˆ¶å¤šä¸ªä»£ç†ä¹‹é—´çš„å·¥ä½œæµç¨‹ã€‚
"""

from autogen_agentchat.agents import AssistantAgent
from autogen_agentchat.teams import DiGraphBuilder, GraphFlow
from autogen_ext.models.openai import OpenAIChatCompletionClient

# ğŸ”¥AIè¶…å…ƒåŸŸé¢‘é“åŸåˆ›è§†é¢‘
# åˆ›å»ºä¸€ä¸ªOpenAIæ¨¡å‹å®¢æˆ·ç«¯
client = OpenAIChatCompletionClient(model="gpt-4.1-nano")

# åˆ›å»ºå†™ä½œä»£ç†
writer = AssistantAgent(
    name="writer",  # ä»£ç†åç§°
    model_client=client,  # ä½¿ç”¨çš„æ¨¡å‹å®¢æˆ·ç«¯
    system_message="ä½ æ˜¯ä¸€åä¸“ä¸šçš„å†™ä½œè€…ï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„è¦æ±‚ï¼Œèµ·è‰ä¸€ä¸ªå…³äºæŒ‡å®šä¸»é¢˜çš„ç®€çŸ­æ–‡æ¡ˆã€‚"
)

# åˆ›å»ºè¯­æ³•ç¼–è¾‘ä»£ç†
editor_grammar = AssistantAgent(
    name="editor_grammar",
    model_client=client,
    system_message="ä½ æ˜¯ä¸€åè¯­æ³•ä¸“å®¶ï¼Œè´Ÿè´£æ£€æŸ¥æ–‡æœ¬çš„è¯­æ³•é”™è¯¯ï¼Œå¹¶æä¾›ä¿®æ­£å»ºè®®ã€‚åªå…³æ³¨è¯­æ³•æ–¹é¢ï¼Œä¸è¦æ”¹å˜å†…å®¹å’Œé£æ ¼ã€‚"
)

# åˆ›å»ºé£æ ¼ç¼–è¾‘ä»£ç†
editor_style = AssistantAgent(
    name="editor_style",
    model_client=client,
    system_message="ä½ æ˜¯ä¸€åæ–‡ä½“é£æ ¼ä¸“å®¶ï¼Œè´Ÿè´£ä¼˜åŒ–æ–‡æœ¬çš„è¡¨è¾¾æ–¹å¼ã€è¯è¯­é€‰æ‹©å’Œæ•´ä½“é£æ ¼ã€‚ä¸è¦å…³æ³¨è¯­æ³•é—®é¢˜ï¼Œä¸“æ³¨äºè®©æ–‡æœ¬æ›´åŠ ç”ŸåŠ¨æœ‰åŠ›ã€‚"
)

# åˆ›å»ºç»ˆå®¡ç¼–è¾‘ä»£ç†
final_reviewer = AssistantAgent(
    name="final_reviewer",
    model_client=client,
    system_message="ä½ æ˜¯ç»ˆå®¡ç¼–è¾‘ï¼Œè´Ÿè´£å°†è¯­æ³•ç¼–è¾‘å’Œé£æ ¼ç¼–è¾‘çš„ç»“æœæ•´åˆï¼Œåˆ¶ä½œæœ€ç»ˆç‰ˆæœ¬ã€‚ç»¼åˆè€ƒè™‘è¯­æ³•æ­£ç¡®æ€§å’Œè¡¨è¾¾æ•ˆæœã€‚"
)

# æ„å»ºå·¥ä½œæµå›¾
# DiGraphBuilder æ˜¯ä¸€ä¸ªæµç•…çš„APIï¼Œç”¨äºæ„å»ºæœ‰å‘å›¾
builder = DiGraphBuilder()

# æ·»åŠ æ‰€æœ‰èŠ‚ç‚¹
builder.add_node(writer).add_node(editor_grammar).add_node(editor_style).add_node(final_reviewer)

# æ·»åŠ ä»writeråˆ°ä¸¤ä¸ªç¼–è¾‘çš„è¾¹ï¼ˆå¹¶è¡Œå±•å¼€ï¼‰
builder.add_edge(writer, editor_grammar)  # writerå®Œæˆåï¼Œeditor_grammarå¼€å§‹å·¥ä½œ
builder.add_edge(writer, editor_style)  # writerå®Œæˆåï¼Œeditor_styleä¹Ÿå¼€å§‹å·¥ä½œ

# æ·»åŠ ä»ä¸¤ä¸ªç¼–è¾‘åˆ°ç»ˆå®¡ç¼–è¾‘çš„è¾¹ï¼ˆåˆå¹¶èŠ‚ç‚¹ï¼‰
builder.add_edge(editor_grammar, final_reviewer)  # editor_grammarå®Œæˆåï¼Œç»“æœä¼ é€’ç»™final_reviewer
builder.add_edge(editor_style, final_reviewer)  # editor_styleå®Œæˆåï¼Œç»“æœä¹Ÿä¼ é€’ç»™final_reviewer

# æ„å»ºå¹¶éªŒè¯å›¾
graph = builder.build()

# åˆ›å»ºGraphFlowå®ä¾‹
# participantså‚æ•°æŒ‡å®šå‚ä¸å·¥ä½œæµçš„æ‰€æœ‰ä»£ç†
# graphå‚æ•°æŒ‡å®šå·¥ä½œæµçš„æ‰§è¡Œå›¾
flow = GraphFlow(
    participants=builder.get_participants(),  # è‡ªåŠ¨è·å–å›¾ä¸­çš„æ‰€æœ‰å‚ä¸è€…
    graph=graph,  # æŒ‡å®šæ‰§è¡Œå›¾
)

# å¼‚æ­¥è¿è¡Œå·¥ä½œæµ
import asyncio

async def main():
    # è¿è¡Œå·¥ä½œæµå¹¶è·å–æµå¼è¾“å‡º
    # run_streamæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªå¯ä»¥å¼‚æ­¥è¿­ä»£çš„äº‹ä»¶æµ
    stream = flow.run_stream(task="è¯·å†™ä¸€æ®µå…³äºäººå·¥æ™ºèƒ½å‘å±•å†å²çš„çŸ­æ–‡ã€‚")

    # æ˜¾ç¤ºæ¯ä¸ªæ­¥éª¤çš„è¾“å‡º
    async for event in stream:
        # æ£€æŸ¥eventæ˜¯å¦æ˜¯TaskResultå¯¹è±¡ï¼ˆæœ€ç»ˆç»“æœï¼‰
        if hasattr(event, 'source'):
            # å¦‚æœæ˜¯æ¶ˆæ¯å¯¹è±¡ï¼Œç›´æ¥æ‰“å°sourceå’Œcontent
            print(f"========== {event.source} ==========")
            print(event.content)
            print("\n")
        else:
            # å¦‚æœæ˜¯TaskResultå¯¹è±¡ï¼Œæ‰“å°ç»“æœä¿¡æ¯
            print("========== ä»»åŠ¡å®Œæˆ ==========")
            print(f"åœæ­¢åŸå› : {event.stop_reason}")
            print(f"æ¶ˆæ¯æ•°é‡: {len(event.messages)}")
            print("\n")

# åœ¨è„šæœ¬ä¸­è¿è¡Œæ—¶ï¼Œä½¿ç”¨asyncio.run()æ‰§è¡Œä¸»å‡½æ•°
if __name__ == "__main__":
    asyncio.run(main())

"""
å›¾çš„æ‰§è¡Œè¿‡ç¨‹è¯´æ˜ï¼š
1. ç”¨æˆ·å‘é€ä»»åŠ¡è¯·æ±‚
2. writerä»£ç†é¦–å…ˆæ‰§è¡Œï¼Œç”Ÿæˆåˆå§‹æ–‡æ®µ
3. writerå®Œæˆåï¼Œeditor_grammarå’Œeditor_styleåŒæ—¶å¼€å§‹å·¥ä½œï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
4. å½“ä¸¤ä¸ªç¼–è¾‘éƒ½å®Œæˆå·¥ä½œåï¼Œfinal_reviewerå¼€å§‹æ•´åˆä»–ä»¬çš„ä¿®æ”¹
5. final_reviewerå®Œæˆåï¼Œå·¥ä½œæµç»“æŸï¼Œè¿”å›æœ€ç»ˆç»“æœ

GraphFlowçš„ä¸»è¦ä¼˜åŠ¿:
- ç²¾ç¡®æ§åˆ¶ä»£ç†ä¹‹é—´çš„æ‰§è¡Œé¡ºåº
- æ”¯æŒå¹¶è¡Œæ‰§è¡Œå¤šä¸ªä»£ç†
- æ”¯æŒæ¡ä»¶åˆ†æ”¯å’Œå¾ªç¯
- å¯ä»¥è¿‡æ»¤æ¯ä¸ªä»£ç†æ¥æ”¶çš„æ¶ˆæ¯ï¼Œä¼˜åŒ–ä¸Šä¸‹æ–‡ç®¡ç†
"""
```

### ğŸ”¥æ—…è¡Œè§„åˆ’æ™ºèƒ½ä½“

```bash
from autogen_agentchat.agents import AssistantAgent, MessageFilterAgent, MessageFilterConfig, PerSourceFilter
from autogen_agentchat.teams import DiGraphBuilder, GraphFlow
from autogen_agentchat.ui import Console
from autogen_ext.models.openai import OpenAIChatCompletionClient
import asyncio

# åˆ›å»ºæ¨¡å‹å®¢æˆ·ç«¯
model_client = OpenAIChatCompletionClient(model="gpt-4.1-nano")

# å®šä¹‰å„ä¸ªä¸“ä¸šæ™ºèƒ½ä½“
# è§„åˆ’å¸ˆæ™ºèƒ½ä½“ - è´Ÿè´£åˆæ­¥æ—…è¡Œè®¡åˆ’åˆ¶å®š
planner_agent = AssistantAgent(
    "planner_agent",
    model_client=model_client,
    description="ä¸€ä¸ªèƒ½å¤Ÿè§„åˆ’æ—…è¡Œçš„åŠ©æ‰‹ã€‚",
    system_message="ä½ æ˜¯ä¸€ä¸ªå¸®åŠ©ç”¨æˆ·æ ¹æ®å…¶éœ€æ±‚è§„åˆ’æ—…è¡Œè®¡åˆ’çš„åŠ©æ‰‹ã€‚æä¾›è¯¦ç»†çš„è¡Œç¨‹å®‰æ’ã€æ™¯ç‚¹å»ºè®®å’Œæ—¶é—´è§„åˆ’ã€‚ä½ çš„å·¥ä½œæ˜¯åˆ›å»ºåŸºç¡€æ—…è¡Œæ¡†æ¶ã€‚",
)

# å½“åœ°ä¸“å®¶æ™ºèƒ½ä½“ - æä¾›å½“åœ°æ´»åŠ¨å’Œæ™¯ç‚¹å»ºè®®
local_agent = AssistantAgent(
    "local_agent",
    model_client=model_client,
    description="ä¸€ä¸ªèƒ½å¤Ÿæ¨èå½“åœ°æ´»åŠ¨æˆ–æ™¯ç‚¹çš„åŠ©æ‰‹ã€‚",
    system_message="ä½ æ˜¯ä¸€ä¸ªèƒ½å¤Ÿä¸ºç”¨æˆ·æ¨èçœŸå®æœ‰è¶£çš„å½“åœ°æ´»åŠ¨æˆ–æ™¯ç‚¹çš„åŠ©æ‰‹ã€‚åŸºäºè§„åˆ’å¸ˆæä¾›çš„åŸºç¡€æ¡†æ¶ï¼Œè¡¥å……æ›´å¤šå½“åœ°ç‰¹è‰²ä½“éªŒã€ç¾é£Ÿå’Œæ–‡åŒ–æ´»åŠ¨çš„è¯¦ç»†ä¿¡æ¯ã€‚æ³¨é‡æä¾›å½“åœ°ç‰¹è‰²å’Œç‹¬ç‰¹ä½“éªŒã€‚",
)

# è¯­è¨€ä¸“å®¶æ™ºèƒ½ä½“ - æä¾›è¯­è¨€å’Œæ²Ÿé€šæŠ€å·§
language_agent = AssistantAgent(
    "language_agent",
    model_client=model_client,
    description="ä¸€ä¸ªèƒ½å¤Ÿä¸ºç‰¹å®šç›®çš„åœ°æä¾›è¯­è¨€æŠ€å·§çš„åŠ©æ‰‹ã€‚",
    system_message="ä½ æ˜¯ä¸€ä¸ªèƒ½å¤Ÿæä¾›ç›®çš„åœ°è¯­è¨€å’Œæ²Ÿé€šæŠ€å·§çš„åŠ©æ‰‹ã€‚åŸºäºè§„åˆ’å¸ˆæä¾›çš„åŸºç¡€æ¡†æ¶ï¼Œæ·»åŠ æœ‰å…³å½“åœ°è¯­è¨€ã€å¸¸ç”¨çŸ­è¯­ã€æ²Ÿé€šç¤¼ä»ªå’Œæ–‡åŒ–å·®å¼‚çš„å»ºè®®ï¼Œå¸®åŠ©æ—…è¡Œè€…æ›´å¥½åœ°ä¸å½“åœ°äººäº¤æµã€‚",
)

# æ€»ç»“æ™ºèƒ½ä½“ - æ•´åˆå„æ–¹å»ºè®®å¹¶ç”Ÿæˆæœ€ç»ˆè®¡åˆ’
travel_summary_agent = AssistantAgent(
    "travel_summary_agent",
    model_client=model_client,
    description="ä¸€ä¸ªèƒ½å¤Ÿæ€»ç»“æ—…è¡Œè®¡åˆ’çš„åŠ©æ‰‹ã€‚",
    system_message="""ä½ æ˜¯ä¸€ä¸ªä¸“é—¨æ•´åˆæœ€ç»ˆæ—…è¡Œè®¡åˆ’çš„åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯ï¼š
1. æŸ¥çœ‹è§„åˆ’å¸ˆæä¾›çš„åŸºç¡€è¡Œç¨‹æ¡†æ¶
2. èåˆå½“åœ°ä¸“å®¶æä¾›çš„ç‰¹è‰²æ´»åŠ¨å’Œä½“éªŒå»ºè®®
3. çº³å…¥è¯­è¨€ä¸“å®¶çš„è¯­è¨€å’Œæ²Ÿé€šæŠ€å·§

ä½ å¿…é¡»åˆ›å»ºä¸€ä¸ªå…¨é¢è€Œè¿è´¯çš„æœ€ç»ˆæ—…è¡Œè®¡åˆ’ï¼ŒåŒ…æ‹¬ï¼š
- æ¯æ—¥è¡Œç¨‹å®‰æ’ï¼ŒåŒ…å«æ—¶é—´ã€åœ°ç‚¹å’Œæ´»åŠ¨
- ç‰¹è‰²ä½“éªŒå’Œç¾é£Ÿæ¨è
- å¿…è¦çš„è¯­è¨€å’Œæ²Ÿé€šæŠ€å·§
- å®ç”¨çš„æ—…è¡Œå»ºè®®

ä½ çš„è¾“å‡ºæ ¼å¼åº”ä¸ºï¼š
- å¼€å¤´ï¼šç®€çŸ­ä»‹ç»
- ä¸­é—´ï¼šæŒ‰å¤©è¯¦ç»†è¡Œç¨‹ï¼ˆç¬¬ä¸€å¤©ã€ç¬¬äºŒå¤©ã€ç¬¬ä¸‰å¤©ï¼‰
- ç»“å°¾ï¼šæ—…è¡Œè´´å£«ï¼ŒåŒ…å«è¯­è¨€æ²Ÿé€šå»ºè®®

è¯·ç¡®ä¿æœ€ç»ˆè®¡åˆ’ç»¼åˆäº†æ‰€æœ‰å…¶ä»–æ™ºèƒ½ä½“çš„å»ºè®®ï¼Œå¹¶ä¸”æ ¼å¼æ¸…æ™°ã€å†…å®¹å®Œæ•´ã€‚
å½“è®¡åˆ’å®Œæˆï¼Œåœ¨æœ€åä¸€è¡Œå•ç‹¬æ·»åŠ 'TERMINATE'ä½œä¸ºæ ‡è®°ã€‚""",
)

# ä½¿ç”¨MessageFilterAgentå¯¹æ¯ä¸ªæ™ºèƒ½ä½“è¿›è¡ŒåŒ…è£…ä»¥æ§åˆ¶æ¶ˆæ¯æµ
# å½“åœ°ä¸“å®¶åªçœ‹åˆ°ç”¨æˆ·è¯·æ±‚å’Œè§„åˆ’å¸ˆçš„æœ€åä¸€æ¡æ¶ˆæ¯
filtered_local_agent = MessageFilterAgent(
    name="local_agent",
    wrapped_agent=local_agent,
    filter=MessageFilterConfig(
        per_source=[
            PerSourceFilter(source="user", position="first", count=1),
            PerSourceFilter(source="planner_agent", position="last", count=1),
        ]
    ),
)

# è¯­è¨€ä¸“å®¶åªçœ‹åˆ°ç”¨æˆ·è¯·æ±‚å’Œè§„åˆ’å¸ˆçš„æœ€åä¸€æ¡æ¶ˆæ¯
filtered_language_agent = MessageFilterAgent(
    name="language_agent",
    wrapped_agent=language_agent,
    filter=MessageFilterConfig(
        per_source=[
            PerSourceFilter(source="user", position="first", count=1),
            PerSourceFilter(source="planner_agent", position="last", count=1),
        ]
    ),
)

# æ€»ç»“æ™ºèƒ½ä½“éœ€è¦çœ‹åˆ°ç”¨æˆ·çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ã€è§„åˆ’å¸ˆçš„æœ€åä¸€æ¡æ¶ˆæ¯ã€å½“åœ°ä¸“å®¶çš„æœ€åä¸€æ¡æ¶ˆæ¯å’Œè¯­è¨€ä¸“å®¶çš„æœ€åä¸€æ¡æ¶ˆæ¯
# è¿™é‡Œä½¿ç”¨æ˜ç¡®çš„åç§°å¹¶ç¡®ä¿é…ç½®æ­£ç¡®
filtered_summary_agent = MessageFilterAgent(
    name="travel_summary_agent",
    wrapped_agent=travel_summary_agent,
    filter=MessageFilterConfig(
        per_source=[
            PerSourceFilter(source="user", position="first", count=1),
            PerSourceFilter(source="planner_agent", position="last", count=1),
            PerSourceFilter(source="local_agent", position="last", count=1),
            PerSourceFilter(source="language_agent", position="last", count=1),
        ],
        default="exclude"  # æ˜ç¡®é»˜è®¤æ’é™¤å…¶ä»–æ¶ˆæ¯
    ),
)

# ä½¿ç”¨DiGraphBuilderæ„å»ºæ··åˆå·¥ä½œæµå›¾
builder = DiGraphBuilder()

# æ·»åŠ æ‰€æœ‰èŠ‚ç‚¹
builder.add_node(planner_agent).add_node(filtered_local_agent).add_node(filtered_language_agent).add_node(filtered_summary_agent)

# æ„å»ºæ‰§è¡Œæµç¨‹
# 1. ç”¨æˆ·è¯·æ±‚é¦–å…ˆä¼ é€’ç»™è§„åˆ’å¸ˆåˆ›å»ºåŸºç¡€æ¡†æ¶
# 2. è§„åˆ’å¸ˆå®Œæˆåï¼ŒåŒæ—¶ä¼ é€’ç»™å½“åœ°ä¸“å®¶å’Œè¯­è¨€ä¸“å®¶ï¼ˆå¹¶è¡Œå¤„ç†ï¼‰
# 3. å½“åœ°ä¸“å®¶å’Œè¯­è¨€ä¸“å®¶éƒ½å®Œæˆåï¼Œå„è‡ªçš„ç»“æœä¼ é€’ç»™æ€»ç»“æ™ºèƒ½ä½“
# è¿™åˆ›å»ºäº†ä¸€ä¸ªæ··åˆé¡ºåº+å¹¶è¡Œçš„å·¥ä½œæµ
builder.add_edge(planner_agent, filtered_local_agent)
builder.add_edge(planner_agent, filtered_language_agent)
builder.add_edge(filtered_local_agent, filtered_summary_agent)
builder.add_edge(filtered_language_agent, filtered_summary_agent)

# æ„å»ºå¹¶éªŒè¯å›¾
graph = builder.build()

# åˆ›å»ºGraphFlowå›¢é˜Ÿ
flow = GraphFlow(
    participants=builder.get_participants(),
    graph=graph,
)

# è¿è¡Œå·¥ä½œæµå¹¶æ ¼å¼åŒ–è¾“å‡º
async def main():
    # è¿è¡Œå·¥ä½œæµå¹¶ä»¥å‹å¥½æ ¼å¼åœ¨æ§åˆ¶å°æ˜¾ç¤ºç»“æœ
    await Console(flow.run_stream(task="ä¸ºæˆ‘è§„åˆ’ä¸€ä¸ª3å¤©çš„å°¼æ³Šå°”ä¹‹æ—…ã€‚"))

    # å…³é—­æ¨¡å‹å®¢æˆ·ç«¯
    await model_client.close()

if __name__ == "__main__":
    asyncio.run(main())
```

